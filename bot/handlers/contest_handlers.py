import asyncio

from aiogram import Router, types, F
from aiogram.filters import StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.types import FSInputFile

from bot.keyboards.contest_boards import inline_first_task_process, inline_third_task_admin_choose, \
    inline_lottery_start, \
    inline_prize_data, inline_sixth_task_hum, inline_sixth_task_phys, inline_third_task_admin_result, \
    inline_seventh_task_start, inline_get_prize_start
from bot.utils.callbacks import Task1Answer, Task3Admin, Task6Answer
from bot.utils.config import task1_config, task2_config, task3_config, task4_config, task5_config, task6_config, \
    task7_config, complete_texts
from bot.utils.filters import MTaskFilter, CTaskFilter, GotPrize
from bot.utils.requests import change_task_type, get_task_type, update_user_activity, got_prize, get_prize, \
    participate_in_lottery, set_lottery_participation
from bot.utils.states import User

router = Router()


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(F.text.lower().contains("–Ω–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç"),
                MTaskFilter(""),
                StateFilter(User.menu_active, User.info_active))
async def first_task_start_handler(message: types.Message, state: FSMContext):
    await message.answer(text=task1_config.start_text)
    await state.set_state(User.quest_active)

    await change_task_type(chat_id=message.chat.id,
                           task_type="start_task1")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task1"))
async def first_task_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–µ—Ä–≤–æ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        await message.answer(text=task1_config.process_text)

        photo = FSInputFile("bot/media/task1/pic_1.jpeg")
        text, reply_markup = inline_first_task_process(question_id=1)

        await message.answer_photo(photo=photo,
                                   reply_markup=reply_markup)

        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task1")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.callback_query(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"), Task1Answer.filter(),
                       StateFilter(User.quest_active),
                       CTaskFilter("do_task1"))
async def first_task_process_handler(callback: types.CallbackQuery, callback_data: Task1Answer):
    question_id = callback_data.question_id
    answer_id = callback_data.answer_id

    if question_id == answer_id and question_id < 4:
        photo = FSInputFile(f"bot/media/task1/pic_{question_id + 1}.jpeg")

        _, reply_markup = inline_first_task_process(question_id=question_id,
                                                    correct_answer_id=answer_id)

        await callback.message.edit_reply_markup(reply_markup=reply_markup)

        text, reply_markup = inline_first_task_process(question_id=question_id + 1)

        await asyncio.sleep(0.05)

        await callback.message.edit_media(media=types.InputMediaPhoto(media=photo),
                                          reply_markup=reply_markup)

    elif question_id == answer_id and question_id == 4:

        _, reply_markup = inline_first_task_process(question_id=question_id,
                                                    correct_answer_id=answer_id)

        await callback.message.edit_reply_markup(reply_markup=reply_markup)

        # await callback.message.answer(text=task1_config.end_text)
        await callback.message.answer(text="–í—Å—ë –≤–µ—Ä–Ω–æ!")  # –ù–∞–¥–æ –ª–∏

        await callback.message.answer(text=task2_config.start_text)
        await change_task_type(chat_id=callback.message.chat.id,
                               task_type="start_task2")

    else:
        text, reply_markup = inline_first_task_process(question_id=question_id,
                                                       wrong_answer_id=answer_id)

        await callback.message.edit_reply_markup(reply_markup=reply_markup)

    await callback.answer()

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏—è –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task2"))
async def second_task_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫–æ –≤—Ç–æ—Ä–æ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        await message.answer(text=task2_config.process_text,
                             parse_mode="HTML",
                             disable_web_page_preview=True)

        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task2")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ç–æ—Ä–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task2"))
async def second_task_process_handler(message: types.Message):
    if message.text.lower() in ("vert dider", "vertdider"):
        await message.answer(text=task2_config.end_text)

        # –°—Ç–∞—Ä—Ç —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await message.answer(text=task3_config.start_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="start_task3")

    else:
        await message.answer(text="–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑, –ø—Ä–æ–≤–µ—Ä—å –æ–ø–µ—á–∞—Ç–∫–∏")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏—è —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task3"))
async def third_task_conditions_handler(message: types.Message, state: FSMContext):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ç—Ä–µ—Ç—å–µ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        await message.answer(text=task3_config.process_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task3")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è (—Ñ–æ—Ç–æ)
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task3"), F.photo)
async def third_task_photo_process_handler(message: types.Message):
    file_id = message.photo[-1].file_id

    reply_markup = inline_third_task_admin_choose(chat_id=message.chat.id)

    await message.bot.send_photo(chat_id=490082094,
                                 photo=file_id,
                                 caption=f"@{message.from_user.username}",
                                 reply_markup=reply_markup)

    await message.answer(text="–ñ–¥–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è (–Ω–µ —Ñ–æ—Ç–æ)
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task3"), ~F.photo)
async def third_task_not_photo_process_handler(message: types.Message):
    await message.answer("–≠—Ç–æ –Ω–µ —Ñ–æ—Ç–æ üòû")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç—Ä–µ—Ç—å–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)
@router.callback_query(Task3Admin.filter())
async def third_task_photo_process_handler(callback: types.CallbackQuery, callback_data: Task3Admin):
    chat_id = callback_data.chat_id
    approved = callback_data.approved

    reply_markup = inline_third_task_admin_result(approved=approved)

    await callback.message.edit_reply_markup(reply_markup=reply_markup)

    if approved:

        await callback.bot.send_message(chat_id=chat_id,
                                        text=task3_config.end_text)

        # –°—Ç–∞—Ä—Ç —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await callback.bot.send_message(chat_id=chat_id,
                                        text=task4_config.start_text)
        await change_task_type(chat_id=chat_id,
                               task_type="start_task4")
    else:
        await callback.bot.send_message(chat_id=chat_id,
                                        text="–§–æ—Ç–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞!")

    await callback.answer()

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏–π —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task4"))
async def fourth_task_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —á–µ—Ç–≤–µ—Ä—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        await message.answer(text=task4_config.process_text)
        await message.answer(text="–ò —Å–ª–µ–¥–æ–º –µ—â—ë –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å:\n–ì–¥–µ –±—ã–ª –õ–µ–≤ –õ–∞–Ω–¥–∞—É –≤–æ –≤—Ä–µ–º—è –µ–∂–æ–≤—â–∏–Ω—ã?")
        await message.answer(text="–ò —Å–∞–º–æ–µ –∑–∞–Ω—è—Ç–Ω–æ–µ: –Ω–∞ —ç—Ç–∏ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞ –û–î–ò–ù –æ—Ç–≤–µ—Ç. –í–ø–∏—à–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ")

        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task4")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ç–≤–µ—Ä—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task4"))
async def fourth_task_process_handler(message: types.Message):
    if "–æ–ø–∞–ª" in message.text.lower():
        await message.answer(text=task4_config.end_text)

        # –°—Ç–∞—Ä—Ç –ø—è—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await message.answer(text=task5_config.start_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="start_task5")
    else:
        await message.answer(text="–î–∞–≤–∞–π –µ—â—ë –æ–¥–Ω—É –ø–æ–ø—ã—Ç–∫—É!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏–π –ø—è—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task5"))
async def fifth_task_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—è—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        await message.answer(text=task5_config.process_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task5")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—è—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task5"))
async def fifth_task_process_handler(message: types.Message):
    if message.text.lower() == "33":
        await message.answer(text=task5_config.end_text)

        # –°—Ç–∞—Ä—Ç —à–µ—Å—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await message.answer(text=task6_config.start_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="start_task6")
    else:
        await message.answer(
            text="–ö–∞–∂–µ—Ç—Å—è, –Ω—É–∂–Ω–∞ –µ—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ (–º—ã –Ω–µ —É–∑–Ω–∞–µ–º, –µ—Å–ª–∏ —Ç—ã –±—É–¥–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º)")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏–π —à–µ—Å—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è (—Ñ–∏–∑)
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task6"))
async def sixth_task_phys_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–µ—Å—Ç–æ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        photo = FSInputFile("bot/media/task6/pic_1.png")
        text, reply_markup = inline_sixth_task_phys()
        await message.answer_photo(photo=photo,
                                   caption=text,
                                   reply_markup=reply_markup)

        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task6_phys")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏—è —à–µ—Å—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è (–≥—É–º)
@router.callback_query(StateFilter(User.quest_active),
                       F.data == "task6_hum",
                       CTaskFilter("do_task6_phys") or CTaskFilter("do_task6_hum"))
async def sixth_task_hum_conditions_handler(callback: types.CallbackQuery):
    await change_task_type(chat_id=callback.message.chat.id,
                           task_type="do_task6_hum")

    text, reply_markup = inline_sixth_task_hum()

    await callback.message.answer(text=text,
                                  reply_markup=reply_markup)
    await callback.answer()

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —à–µ—Å—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è (—Ñ–∏–∑)
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task6_phys"))
async def sixth_task_phys_process_handler(message: types.Message):
    if message.text == "33":
        await message.answer(text=task6_config.end_text)

        # –°—Ç–∞—Ä—Ç —Å–µ–¥—å–º–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await message.answer(text=task7_config.start_text)
        await change_task_type(chat_id=message.chat.id,
                               task_type="start_task7")
    else:
        await message.answer(
            text="–ö–∞–∂–µ—Ç—Å—è, —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –µ—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —à–µ—Å—Ç–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è (–≥—É–º)
@router.callback_query(StateFilter(User.quest_active),
                       CTaskFilter("do_task6_hum"),
                       Task6Answer.filter())
async def sixth_task_phys_process_handler(callback: types.CallbackQuery, callback_data: Task6Answer.filter()):
    answer_id = callback_data.answer_id

    text, reply_markup = inline_sixth_task_hum(answer_id=answer_id)
    await callback.message.edit_text(text=text,
                                     reply_markup=reply_markup)

    if answer_id == 1:
        await callback.message.answer(
            text='–°–º–æ–∂–µ—Ç, —Å–º–æ–∂–µ—Ç. –°–∏–ª–∞ –≤ 2 –Ω—å—é—Ç–æ–Ω–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–µ—Ä–∂–∞—Ç—å —Ü–µ–ª—ã—Ö 204 –≥—Ä–∞–º–º–∞ –∫–µ—Ñ–∏—Ä–∞. '
                 '–ò–ª–∏ —Ç–∞–∫–æ–µ –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–º–º —Ä–∞—Å—Å–æ–ª–∞.')

        # –°—Ç–∞—Ä—Ç —Å–µ–¥—å–º–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        await callback.message.answer(text=task7_config.start_text)
        await change_task_type(chat_id=callback.message.chat.id,
                               task_type="start_task7")

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è —É—Å–ª–æ–≤–∏–π —Å–µ–¥—å–º–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("start_task7"))
async def seventh_task_conditions_handler(message: types.Message):
    if message.text.lower() == "–∫–æ–¥":
        await message.answer(text="–£—Ä–∞, –∫–æ–¥ –≤–µ—Ä–Ω—ã–π! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –∑–∞–¥–∞–Ω–∏—é!")

        text, reply_markup = inline_seventh_task_start()

        await message.answer(text=text,
                             reply_markup=reply_markup)

        await change_task_type(chat_id=message.chat.id,
                               task_type="do_task7")
    else:
        await message.answer(text="–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ–¥—å–º–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è
@router.message(~F.text.lower().contains("—É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ —Ä–∞–±–æ—Ç—É —Ü–µ–Ω—Ç—Ä–∞"),
                StateFilter(User.quest_active),
                MTaskFilter("do_task7"))
async def seventh_task_conditions_handler(message: types.Message):
    if message.text == "33":
        await message.answer(text=task7_config.end_text)

        await message.answer(text=complete_texts[0],
                             parse_mode="HTML",
                             disable_web_page_preview=True)

        await message.answer(text=complete_texts[1],
                             parse_mode="HTML",
                             disable_web_page_preview=True)

        await change_task_type(chat_id=message.chat.id,
                               task_type="complete")

        text, reply_markup = inline_get_prize_start()

        await message.answer(text=text,
                             reply_markup=reply_markup)

    else:
        await message.answer(
            text="–ö–∞–∂–µ—Ç—Å—è, —Ç–µ–±–µ –Ω—É–∂–Ω–∞ –µ—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ (–ø–µ—Ä–≤–∏—á–Ω–æ–µ)
@router.callback_query(StateFilter(User.quest_active),
                       CTaskFilter("complete"),
                       ~GotPrize(),
                       F.data == "get_prize")
async def get_prize_handler(callback: types.CallbackQuery):
    prize_data = await get_prize(chat_id=callback.message.chat.id)

    if prize_data:
        photo = FSInputFile(f"bot/media/logos/pic_{prize_data.get('id')}.jpeg")
        text, reply_keyboard = inline_prize_data(prize_data=prize_data)
        await callback.message.answer_photo(photo=photo,
                                            caption=text,
                                            reply_keyboard=reply_keyboard)
    else:
        await callback.message.answer(text="–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–¥–∞—Ä–∫–∏ –∫–æ–Ω—á–∏–ª–∏—Å—å üòî")

    text, reply_markup = inline_lottery_start()
    await callback.message.answer(text=text,
                                  reply_markup=reply_markup)

    await callback.message.answer(text=complete_texts[4])

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–∞ (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ)
@router.callback_query(StateFilter(User.quest_active),
                       CTaskFilter("complete"),
                       GotPrize(),
                       F.data == "get_prize")
async def used_get_prize_handler(callback: types.CallbackQuery):
    await callback.message.answer(text="–í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫! üéÅ")

    if participate_in_lottery(chat_id=callback.message.chat.id):
        await callback.message.answer(text="–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –ª–æ—Ç–µ—Ä–µ–µ! üé´")
        await callback.message.answer(text=complete_texts[4])
    else:
        text, reply_markup = inline_lottery_start()
        await callback.message.answer(text=text,
                                      reply_markup=reply_markup)

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–æ—Ç–µ—Ä–µ–∏ (–ø–µ—Ä–≤–∏—á–Ω–æ–µ)
@router.callback_query(StateFilter(User.quest_active),
                       CTaskFilter("complete"),
                       GotPrize(),
                       F.data == "lottery_start")
async def lottery_prize_handler(callback: types.CallbackQuery):
    if participate_in_lottery(chat_id=callback.message.chat.id):
        await callback.message.answer(text="–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –ª–æ—Ç–µ—Ä–µ–µ! üé´")
    else:
        await set_lottery_participation(chat_id=callback.message.chat.id)

    await callback.message.answer(text=complete_texts[4])

    await update_user_activity(chat_id=callback.message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏—è –∫ –∑–∞–¥–∞–Ω–∏—é
@router.message(F.text.lower().contains("–Ω–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç"),
                ~MTaskFilter(""),
                StateFilter(User.menu_active, User.info_active))
async def return_task_handler(message: types.Message, state: FSMContext):
    await state.set_state(User.quest_active)
    task_type = await get_task_type(chat_id=message.chat.id)
    if task_type == "start_task1":
        await message.answer(text=task1_config.start_text)
    elif task_type == "do_task1":
        photo = FSInputFile("bot/media/task1/pic_1.jpeg")
        text, reply_markup = inline_first_task_process(question_id=1)

        await message.answer_photo(photo=photo,
                                   reply_markup=reply_markup)
    elif task_type == "start_task2":
        await message.answer(text=task2_config.start_text)
    elif task_type == "do_task2":
        await message.answer(text=task2_config.process_text,
                             parse_mode="HTML",
                             disable_web_page_preview=True)
    elif task_type == "start_task3":
        await message.answer(text=task3_config.start_text)
    elif task_type == "do_task3":
        await message.answer(text=task3_config.process_text)
    elif task_type == "start_task4":
        await message.answer(text=task4_config.start_text)
    elif task_type == "do_task4":
        await message.answer(text=task4_config.process_text)
        await message.answer(text="–ò —Å–ª–µ–¥–æ–º –µ—â—ë –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å:\n–ì–¥–µ –±—ã–ª –õ–µ–≤ –õ–∞–Ω–¥–∞—É –≤–æ –≤—Ä–µ–º—è –µ–∂–æ–≤—â–∏–Ω—ã?")
        await message.answer(text="–ò —Å–∞–º–æ–µ –∑–∞–Ω—è—Ç–Ω–æ–µ: –Ω–∞ —ç—Ç–∏ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞ –û–î–ò–ù –æ—Ç–≤–µ—Ç.\n–í–ø–∏—à–∏—Ç–µ –µ–≥–æ –Ω–∏–∂–µ")
    elif task_type == "start_task5":
        await message.answer(text=task5_config.start_text)
    elif task_type == "do_task5":
        await message.answer(text=task5_config.process_text)
    elif task_type == "start_task6":
        await message.answer(text=task6_config.start_text)
    elif task_type == "do_task6_phys":
        photo = FSInputFile("bot/media/task6/pic_1.png")
        text, reply_markup = inline_sixth_task_phys()
        await message.answer_photo(photo=photo,
                                   caption=text,
                                   reply_markup=reply_markup)
    elif task_type == "do_task6_hum":
        text, reply_markup = inline_sixth_task_hum()
        await message.answer(text=text,
                             reply_markup=reply_markup)

    elif task_type == "start_task7":
        await message.answer(text=task7_config.start_text)
    elif task_type == "do_task7":
        await message.answer(text=task7_config.process_text)
    elif task_type == "complete":
        await message.answer(text=complete_texts[0],
                             parse_mode="HTML",
                             disable_web_page_preview=True)

        await message.answer(text=complete_texts[1],
                             parse_mode="HTML",
                             disable_web_page_preview=True)

        if got_prize(chat_id=message.chat.id):
            await message.answer(text="–í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫! üéÅ")
        else:
            text, reply_markup = inline_get_prize_start()
            await message.answer(text=text,
                                 reply_markup=reply_markup)

        if participate_in_lottery(chat_id=message.chat.id):
            await message.answer(text="–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –ª–æ—Ç–µ—Ä–µ–µ! üé´")
            await message.answer(text=complete_texts[4])
        else:
            text, reply_markup = inline_lottery_start
            await message.answer(text=text,
                                 reply_markup=reply_markup)

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∫–≤–µ—Å—Ç–∞ –∏–∑–Ω—É—Ç—Ä–∏ (not complete)
@router.message(F.text.lower().contains("–Ω–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç"),
                StateFilter(User.quest_active),
                ~MTaskFilter("complete"))
async def inform_quest_handler(message: types.Message):
    await message.answer(text="–í—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ –∫–≤–µ—Å—Ç!")

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ –∫–≤–µ—Å—Ç–∞ –∏–∑–Ω—É—Ç—Ä–∏ (complete)
@router.message(F.text.lower().contains("–Ω–∞—á–∞—Ç—å –∫–≤–µ—Å—Ç"),
                StateFilter(User.quest_active),
                MTaskFilter("complete"))
async def inform_complete_quest_handler(message: types.Message):
    await message.answer(text=complete_texts[0],
                         parse_mode="HTML",
                         disable_web_page_preview=True)

    await message.answer(text=complete_texts[1],
                         parse_mode="HTML",
                         disable_web_page_preview=True)

    if got_prize(chat_id=message.chat.id):
        await message.answer(text="–í—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–¥–∞—Ä–æ–∫! üéÅ")
    else:
        text, reply_markup = inline_get_prize_start()
        await message.answer(text=text,
                             reply_markup=reply_markup)

    if participate_in_lottery(chat_id=message.chat.id):
        await message.answer(text="–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ –ª–æ—Ç–µ—Ä–µ–µ! üé´")
        await message.answer(text=complete_texts[4])
    else:
        text, reply_markup = inline_lottery_start
        await message.answer(text=text,
                             reply_markup=reply_markup)

    await update_user_activity(chat_id=message.chat.id)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è inactive inline –∫–Ω–æ–ø–æ–∫
@router.callback_query(F.data == "inactive")
async def inactive_button_handler(callback: types.CallbackQuery):
    await callback.answer()
    await update_user_activity(chat_id=callback.message.chat.id)
